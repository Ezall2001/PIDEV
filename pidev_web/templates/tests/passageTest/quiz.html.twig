{% extends 'layouts/user.html.twig' %}
{% block main %}
	<!-- <img src="{{ qr_code_path('https://www.youtube.com/watch?v=_tee_eoVSj8') }}"/> -->
	<body class="">
		<div class="account-pages mt-5 mb-5">
			<div class="container">
				<div class="row justify-content-center">
					<div class="col-md-8 col-lg-6 col-xl-5">
						<div class="text-center">
							<h1 class="display-4 text-center">
								Page du
								<span class="text-primary">Quiz</span>
							</h1>
							<p class="text-muted mt-2 mb-4">Bonne chance :)</p>
							<div class="timer">Temps restant :
								<li class="fs-3 text-danger" style="list-style-type: none;" id="countdown" value={{test.duration}}>{{test.duration}}:00</li>
							</div>
							<input hidden type="text" id="testId" value={{test.id}}>
							<br>
						</div>
						{% for i in 0..q|length-1 %}
							<div class="card">
								<div class="card-body p-4">

									<div class="list-group list-group-flush ">
										<label class="fw-semibold fs-4" for="question">{{q[i].question}}</label>
										<br>

										<div class="radio list-group-item">
											<input id="{{q[i].id}}" class="form-check-input" type="radio" name="question{{i}}" value="{{q[i].optiona}}">
											<label class="form-check-label">{{q[i].optiona}}</label>
										</div>
										<div class="radio list-group-item">
											<input id="{{q[i].id}}" class="form-check-input" type="radio" name="question{{i}}" value="{{q[i].optionb}}">
											<label class="form-check-label">{{q[i].optionb}}</label>
										</div>
										<div class="radio list-group-item">
											<input id="{{q[i].id}}" class="form-check-input" type="radio" name="question{{i}}" value="{{q[i].optionc}}">
											<label class="form-check-label">{{q[i].optionc}}</label>
										</div>
										<div class="radio list-group-item">
											<input id="{{q[i].id}}" class="form-check-input" type="radio" name="question{{i}}" value="{{q[i].optiond}}">
											<label class="form-check-label">{{q[i].optiond}}</label>
										</div>
										<div class="radio">
											<label hidden><input type="radio" name="question{{i}}" value="{{q[i].correctOption}}" id="correctOption">{{q[i].correctOption}}</label>
										</div>
									</div>
								</div>
								<!-- end card-body -->
							</div>
							<!-- end card -->
						{% endfor %}
						<button id="btn" type="submit" class="btn btn-info" onclick="terminer_test(); ">Terminer test</button>
					</div>

					<!-- end col -->
				</div>
				<!-- end row -->
			</div>
			<!-- end container -->
		</div>
		<!-- end page -->
		<!-- result modal -->
		<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content text-center">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="staticBackdropLabel">Résultat test</h1>
					</div>
					<div class="modal-body bg-light ">
						<p id="nb_questions" data-nb={{nb_questions}}></p>
						<p>Félicitations pour avoir terminé le test !</p>
					</div>
					<div class="modal-footer">

						<button type="button" class="btn btn-danger" data-bs-dismiss="modal" onclick="redirect()">Quitter</button>
						<a onclick="redirect();" href="{{path('resultDownload',{'id':test.id})}}">
							<button hidden id="printBtn" type="button" class="btn btn-primary ">Imprimer</button>
						</a>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="danger-alert-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
			<div class="modal-dialog modal-sm">
				<div class="modal-content text-center">
					<div class="modal-content modal-filled bg-danger ">
						<div class="modal-body">
							<div class="text-center">
								<i class="dripicons-wrong h1 text-white"></i>
								<h4 class="mt-2 text-white">Oups !</h4>
								<p class="mt-3 text-white">Le temps est écoulé :/
								</p>
								<button type="button" class="btn btn-light my-2" data-bs-dismiss="modal" onclick="redirect()">Quitter</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>


		<div class="modal fade" id="warning-alert-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
			<div class="modal-dialog modal-sm">
				<div class="modal-content text-center">
					<div class="modal-body">
						<div class="text-center">
							<i class="dripicons-warning h1 text-warning"></i>
							<h4 class="mt-2">Erreur</h4>
							<p class="mt-3">Veuillez répondre à toutes les questions !</p>
							<button type="button" class="btn btn-warning my-2" data-bs-dismiss="modal">Continuer</button>
						</div>
					</div>
				</div>
			</div>
		</div>


		<!-- Vendor js -->
		<script src="../assets/js/vendor.min.js"></script>

		<!-- App js -->
		<script src="../assets/js/app.min.js"></script>


		<!-- my js -->
		<script>

			document.getElementById("btn").addEventListener("click", function (event) {
event.preventDefault()
});

let score = 0;
let radioCount = 0;
// nombre des questions
let nbQuestionsEl = document.getElementById('nb_questions');
let nbQuestions = parseInt(nbQuestionsEl.getAttribute('data-nb'));

// les réponses correctes
let correctOptions = document.querySelectorAll('input[id="correctOption"]');

let limit = nbQuestions;
let finishBtn = document.getElementById("btn");
let printBtn = document.getElementById("printBtn");
console.log(nbQuestions);


function terminer_test() {
var modal = new bootstrap.Modal(document.getElementById("staticBackdrop"));
// valeurs selectionnées
let selectedValues = document.querySelectorAll('input[type="radio"]:checked');
let selectedValuesArray = Array.from(selectedValues)

let correctOptionsArray = Array.from(correctOptions)


if (selectedValues.length != nbQuestions) 

toggleWariningModal()





for (let i = 0; i < nbQuestions; i++) {
if (selectedValuesArray[i].value.toString() === correctOptionsArray[i].value.toString()) {
score++;
}


if (score > limit) 
score = limit;



}

if (score === nbQuestions) 
printBtn.removeAttribute("hidden");



let responses = [];
for (let i = 0; i < selectedValuesArray.length; i++) {
responses[i] = {
id: selectedValuesArray[i].id,
value: selectedValuesArray[i].value
}
}

if (selectedValues.length === nbQuestions) {
$.ajax({
url: '/check/' + document.getElementById('testId').value,
type: 'POST',
contentType: 'application/json',
data: JSON.stringify(
{responses: responses}
),
success: function (data) {
resultText = `Vous avez obtenu une note de ${
data.nbCorrectOption
}  sur ${nbQuestions}`;
document.getElementById('nb_questions').innerHTML = resultText;
modal.toggle();
}
});

}


}

function redirect() {
let newPageUrl = '{{ path('getUserTests') }}';
window.location.href = newPageUrl;
}

// ------------------------ countdown timer -------------------------------------
let durationMinutes = document.querySelector('li[id="countdown"]').value

let time = durationMinutes * 60 - 1

let countdownEl = document.querySelector('li[id="countdown"]')
setInterval(updateCoundown, 1000)


function updateCoundown() {
let minutes = Math.floor(time / 60)
let seconds = time % 60

if (time >= 0) {
seconds = seconds < durationMinutes ? '0' + seconds : seconds


countdownEl.innerHTML = `${minutes}:${seconds}`
time--
if (seconds < 10 && seconds != 0) 
countdownEl.innerHTML = `${minutes}:0${seconds}`





if (time === 0) 
toggleErrorModal()





}


}


function toggleErrorModal() {
var button = document.getElementById("btn");

var modal = new bootstrap.Modal(document.getElementById("danger-alert-modal"));
modal.toggle();
}

function toggleWariningModal() {
var button = document.getElementById("btn");

var modal = new bootstrap.Modal(document.getElementById("warning-alert-modal"));
modal.toggle();

}
		</script>
		<!-- Bootstrap JS -->
		<!-- Bootstrap JS -->
		<!-- Bootstrap JS --><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"> </script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	</body>
{% endblock %}
